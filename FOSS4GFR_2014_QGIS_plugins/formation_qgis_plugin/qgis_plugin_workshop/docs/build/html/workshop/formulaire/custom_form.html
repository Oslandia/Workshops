
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Création de formulaires spécialisés &mdash; QGIS Workshop v1.0.0 documentation</title>
    <link rel="stylesheet" href="../../_static/bootstrap/css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/linfiniti.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1.0.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="QGIS Workshop v1.0.0 documentation" href="../../index.html" />
    <link rel="up" title="4e partie - Formulaires spécialisés" href="index.html" />
    <link rel="next" title="5e partie - Développer au grand jour" href="../developper/index.html" />
    <link rel="prev" title="4e partie - Formulaires spécialisés" href="index.html" /> 
  </head>
  <body>
    <div class="container">
      <div class="row">
        <div class="span3">
      <div class="well sidebar-nav">
          <a class="brand" href="http://qgis.org">
          <br />
          <center>QGIS Workshop</center></a>
            <h4>Contents</h4>
            <hr />
            <ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">Tutoriel</a></li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="index.html"
                        title="previous chapter">4e partie - Formulaires spécialisés</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../developper/index.html"
                        title="next chapter">5e partie - Développer au grand jour</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../../_sources/workshop/formulaire/custom_form.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
            
            
            
          <a rel="license"
            href="http://creativecommons.org/licenses/by-sa/3.0/"><img
            alt="Creative Commons License" style="border-width:0"
            src="http://i.creativecommons.org/l/by-sa/3.0/80x15.png" /></a><br
          /><span xmlns:dct="http://purl.org/dc/terms/"
            property="dct:title">Linfiniti Sphinx Theme</span> by <a
            xmlns:cc="http://creativecommons.org/ns#"
            href="http://linfiniti.com" property="cc:attributionName"
            rel="cc:attributionURL">Linfiniti Consulting CC.</a> is licensed
          under a <a rel="license"
            href="http://creativecommons.org/licenses/by-sa/3.0/">Creative
            Commons Attribution-ShareAlike 3.0 Unported License</a>.<br />Based
          on a work at <a xmlns:dct="http://purl.org/dc/terms/"
            href="https://github.com/timlinux/linfiniti-sphinx-theme"
            rel="dct:source">github.com</a>.
      </div>
        </div><!-- span9 -->
        <div class="span9">
              
  <div class="section" id="creation-de-formulaires-specialises">
<h1>Création de formulaires spécialisés<a class="headerlink" href="#creation-de-formulaires-specialises" title="Permalink to this headline">¶</a></h1>
<p>Une possibilité intéressante de personnaliser QGIS est de créer des formulaires personnalisés pour les données. QGIS intègre un mécanisme qui rend la création de tels formulaires relativement simples.</p>
<p>Nous pouvons aller un peu plus loin avec ce mécanisme en y ajoutant des actions de validation de données par exemple.</p>
<div class="section" id="creation-du-formulaire-specialise">
<h2>Création du formulaire spécialisé<a class="headerlink" href="#creation-du-formulaire-specialise" title="Permalink to this headline">¶</a></h2>
<p>Nous allons utiliser ici Qt Designer. On lance donc cet outil et on sélectionne &#8220;Dialog with Buttons Bottom&#8221;. On crée la boîte de dialogue.</p>
<p>Nous prendrons comme exemple le fichier <em>50m_admin_0_countries</em> qui a notamment les champs suivants:</p>
<ul class="simple">
<li>ADM0_A3</li>
<li>NAME</li>
<li>SOVISO</li>
<li>TYPE</li>
<li>PEOPLE</li>
<li>GDP_USDM</li>
<li>COMMENT</li>
</ul>
<p>Nous allons créer un formulaire qui prenne en compte tout d&#8217;abord l&#8217;identifiant unique <strong>ADM0_A3</strong> et le champ <strong>NAME</strong> pour les présenter et permettre de les éditer plus simplement.</p>
<p>Ajoutons quelques labels et éditeurs de lignes correspondant à la donnée. Réglons maintenant notre formulaire pour utiliser un arrangement en grille (clic droit sur un espace vide -&gt; Layout -&gt; Layout in Grid).</p>
<p>L&#8217;astuce pour fabriquer un formulaire spécialisé pour QGIS est de donner aux objets du formulaire le même nom que les champs de la couche de données.</p>
<p>On clique droit sur chaque widget d&#8217;édition de texte et on change le <strong>objectName</strong>, en leur donnant le nom du champ correspondant de la couche concernée.</p>
<p>On enregistre le formulaire ( <em>.ui</em> ) dans notre espace de travail.
Dans QGIS, on ouvre la boîte de dialogue des propriétés de la couche. Dans l&#8217;onglet général on sélectionne pour &#8220;Éditer l&#8217;interface&#8221; notre fichier .ui précedemment sauvé.</p>
<p>On peut maintenant passer en mode édition et sélectionner un objet avec l&#8217;outil d&#8217;identification de feature.
Notre formulaire apparaît ! Nous sommes en mode édition donc tous les changement que l&#8217;on effectue dans le formulaire vont être répercutés dans le fichier. Si nous ne sommes pas en mode édition alors le formulaire apparait avec les widgets désactivés et juste un bouton &#8220;Annuler&#8221;.</p>
</div>
<div class="section" id="validation-et-logique">
<h2>Validation et logique<a class="headerlink" href="#validation-et-logique" title="Permalink to this headline">¶</a></h2>
<div class="section" id="creation-du-module">
<h3>Création du module<a class="headerlink" href="#creation-du-module" title="Permalink to this headline">¶</a></h3>
<p>Créer un formulaire spécialisé est une première étape intéressante mais ajouter du code pour pouvoir faire de la validation serait encore plus intéressant.
Nous voulons ici ajouter une validation au champ NAME pour que l&#8217;utilisateur ne puisse pas ajouter de pays sans nom (avec un nom NULL).</p>
<p>On commence par sauver le projet QGIS. Le module Python que nous allons développer sera recherché dans le répertoire du projet. Ouvrons un éditeur de texte et entrons le code suivant:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">PyQt4.QtCore</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">PyQt4.QtGui</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">nameField</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">myDialog</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">formOpen</span><span class="p">(</span><span class="n">dialog</span><span class="p">,</span><span class="n">layerid</span><span class="p">,</span><span class="n">featureid</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">myDialog</span>
    <span class="n">myDialog</span> <span class="o">=</span> <span class="n">dialog</span>
    <span class="k">global</span> <span class="n">nameField</span>
    <span class="n">nameField</span> <span class="o">=</span> <span class="n">dialog</span><span class="o">.</span><span class="n">findChild</span><span class="p">(</span><span class="n">QLineEdit</span><span class="p">,</span><span class="s">&quot;NAME&quot;</span><span class="p">)</span>
    <span class="n">buttonBox</span> <span class="o">=</span> <span class="n">dialog</span><span class="o">.</span><span class="n">findChild</span><span class="p">(</span><span class="n">QDialogButtonBox</span><span class="p">,</span><span class="s">&quot;buttonBox&quot;</span><span class="p">)</span>

    <span class="c"># Deconnexion du signal que QGIS a automatiquement associe a la zone de boutons</span>
    <span class="n">buttonBox</span><span class="o">.</span><span class="n">accepted</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="n">myDialog</span><span class="o">.</span><span class="n">accept</span><span class="p">)</span>

    <span class="c"># Branchement de nos propres signaux</span>
    <span class="n">buttonBox</span><span class="o">.</span><span class="n">accepted</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">validate</span><span class="p">)</span>
    <span class="n">buttonBox</span><span class="o">.</span><span class="n">rejected</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">myDialog</span><span class="o">.</span><span class="n">reject</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">validate</span><span class="p">():</span>
  <span class="c"># Assurons nous que le nom n&#39;est pas vide</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">nameField</span><span class="o">.</span><span class="n">text</span><span class="p">()</span><span class="o">.</span><span class="n">length</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">msgBox</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">()</span>
        <span class="n">msgBox</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s">&quot;Le champ NAME ne peut pas etre vide.&quot;</span><span class="p">)</span>
        <span class="n">msgBox</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c"># Retournons la boîte de dialogue a QGIS comme acceptee</span>
        <span class="n">myDialog</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
</pre></div>
</div>
<p>Reprenons le code en détaillant les différentes étapes</p>
</div>
<div class="section" id="detail-du-module">
<h3>Détail du module<a class="headerlink" href="#detail-du-module" title="Permalink to this headline">¶</a></h3>
<p>Tout d&#8217;abord nous importons les modules de Qt et réglons quelques variables globales qui vont contenir le nom du champ courant et la boîte de dialogue:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">PyQt4.QtCore</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">PyQt4.QtGui</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">nameField</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">myDialog</span> <span class="o">=</span> <span class="bp">None</span>
</pre></div>
</div>
<p>Nous créons ensuite une méthode que QGIS va appeler quand il charge le formulaire. Cette méthode prend en argument une instance de notre formulaire personnalisé, l&#8217;identifiant de la couche, et l&#8217;identifiant de la feature:</p>
<div class="highlight-python"><pre>def formOpen(dialog,layerid,featureid):</pre>
</div>
<p>Ensuite en utilisant la méthode <em>findChild</em> nous récupérons la référence au champ NAME et aux boutons (la buttonBox). Nous appelons aussi <strong>buttonBox.accepted.disconnect()</strong> pour déconnecter les slots que QGIS a automatiquement attaché à nos boutons, de façons à pouvoir y mettre notre propre logique de validation.</p>
<p>Après avoir déconnecté le signal de validation on peut brancher notre propre appel à la méthode de validation en utilisant <strong>buttonBox.accepted.connect(validate)</strong></p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">global</span> <span class="n">myDialog</span>
<span class="n">myDialog</span> <span class="o">=</span> <span class="n">dialog</span>
<span class="k">global</span> <span class="n">nameField</span>
<span class="n">nameField</span> <span class="o">=</span> <span class="n">dialog</span><span class="o">.</span><span class="n">findChild</span><span class="p">(</span><span class="n">QLineEdit</span><span class="p">,</span><span class="s">&quot;Name&quot;</span><span class="p">)</span>
<span class="n">buttonBox</span> <span class="o">=</span> <span class="n">dialog</span><span class="o">.</span><span class="n">findChild</span><span class="p">(</span><span class="n">QDialogButtonBox</span><span class="p">,</span><span class="s">&quot;buttonBox&quot;</span><span class="p">)</span>
<span class="c"># Deconnexion du signal que QGIS a automatiquement associe a la zone de boutons</span>
<span class="n">buttonBox</span><span class="o">.</span><span class="n">accepted</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="n">myDialog</span><span class="o">.</span><span class="n">accept</span><span class="p">)</span>

<span class="c"># Branchement de nos propres signaux</span>
<span class="n">buttonBox</span><span class="o">.</span><span class="n">accepted</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">validate</span><span class="p">)</span>
<span class="n">buttonBox</span><span class="o">.</span><span class="n">rejected</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">myDialog</span><span class="o">.</span><span class="n">reject</span><span class="p">)</span>
</pre></div>
</div>
<p>Nous avons besoin d&#8217;une méthode pour valider la logique du formulaire. Celle ci sera appelée quand le signal <strong>buttonBox.accepted()</strong> est lancé. La logique de cette méthode de validation sera très simple. Si la boîte d&#8217;édition de texte a une longueur positive on accepte la validation, sinon on donne un message d&#8217;erreur à l&#8217;utilisateur pour qu&#8217;il corrige l&#8217;erreur:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">validate</span><span class="p">():</span>
  <span class="c"># Assurons nous que le nom n&#39;est pas vide</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">nameField</span><span class="o">.</span><span class="n">text</span><span class="p">()</span><span class="o">.</span><span class="n">length</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">msgBox</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">()</span>
        <span class="n">msgBox</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s">&quot;Name field can not be null.&quot;</span><span class="p">)</span>
        <span class="n">msgBox</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c"># Retournons la boîte de dialogue a QGIS comme acceptee</span>
        <span class="n">myDialog</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="configuration-qgis">
<h3>Configuration QGIS<a class="headerlink" href="#configuration-qgis" title="Permalink to this headline">¶</a></h3>
<p>Maintenant que nous avons notre fonction de validation, il reste à dire à QGIS de l&#8217;utiliser. Sauvez le fichier dans le même répertoire que votre projet QGIS. QGIS va chercher notre module dans le répertoire du projet et dans les répertoires de Python, c&#8217;est à dire les répertoires par défaut et ceux définis dans le PYTHONPATH.</p>
<p>Dans l&#8217;onglet général des propriétés de la couche, on peut régler le champ de fonction d&#8217;initialisation. La syntaxe est <em>{nom du module}.{nom de la fonction}</em>. Dans notre cas le module (le fichier Python que l&#8217;on vient de créer) s&#8217;appelle <strong>CountryForm</strong> et la fonction est nommée <strong>formOpen</strong> donc on spécifie dans l&#8217;interface de QGIS <strong>CountryForm.formOpen</strong>.</p>
<p>On sauve et on utilise l&#8217;outil d&#8217;identification de feature pour en sélectionner une. Si tout est OK, vous ne devriez pas avoir d&#8217;erreur. Maintenant essayez de vider le champs NAME et appuyez sur OK. Un message d&#8217;erreur devrait apparaître.</p>
<p>L&#8217;édition des champs ne peut donc être validée que si le champ NAME n&#8217;est pas nul.</p>
</div>
</div>
<div class="section" id="aller-plus-loin">
<h2>Aller plus loin<a class="headerlink" href="#aller-plus-loin" title="Permalink to this headline">¶</a></h2>
<p>On peut au lieu d&#8217;afficher un message d&#8217;erreur rendre le textbox rouge si quelque chose n&#8217;est pas valide:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">PyQt4.QtCore</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">PyQt4.QtGui</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">nameField</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">myDialog</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">formOpen</span><span class="p">(</span><span class="n">dialog</span><span class="p">,</span><span class="n">layerid</span><span class="p">,</span><span class="n">featureid</span><span class="p">):</span>
  <span class="k">global</span> <span class="n">myDialog</span>
  <span class="n">myDialog</span> <span class="o">=</span> <span class="n">dialog</span>
  <span class="k">global</span> <span class="n">nameField</span>
  <span class="n">nameField</span> <span class="o">=</span> <span class="n">dialog</span><span class="o">.</span><span class="n">findChild</span><span class="p">(</span><span class="n">QLineEdit</span><span class="p">,</span><span class="s">&quot;NAME&quot;</span><span class="p">)</span>
  <span class="n">buttonBox</span> <span class="o">=</span> <span class="n">dialog</span><span class="o">.</span><span class="n">findChild</span><span class="p">(</span><span class="n">QDialogButtonBox</span><span class="p">,</span><span class="s">&quot;buttonBox&quot;</span><span class="p">)</span>

  <span class="n">nameField</span><span class="o">.</span><span class="n">textChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">Name_onTextChanged</span><span class="p">)</span>
  <span class="c"># Disconnect the signal that QGIS has wired up for the dialog to the button box.</span>
  <span class="n">buttonBox</span><span class="o">.</span><span class="n">accepted</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="n">myDialog</span><span class="o">.</span><span class="n">accept</span><span class="p">)</span>
  <span class="c"># Wire up our own signals.</span>
  <span class="n">buttonBox</span><span class="o">.</span><span class="n">accepted</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">validate</span><span class="p">)</span>
  <span class="n">buttonBox</span><span class="o">.</span><span class="n">rejected</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">myDialog</span><span class="o">.</span><span class="n">reject</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">validate</span><span class="p">():</span>
  <span class="c"># Make sure that the name field isn&#39;t empty.</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">nameField</span><span class="o">.</span><span class="n">text</span><span class="p">()</span><span class="o">.</span><span class="n">length</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">nameField</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s">&quot;background-color: rgba(255, 107, 107, 150);&quot;</span><span class="p">)</span>
    <span class="n">msgBox</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">()</span>
    <span class="n">msgBox</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s">&quot;Name field can not be null.&quot;</span><span class="p">)</span>
    <span class="n">msgBox</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>
  <span class="k">else</span><span class="p">:</span>
  <span class="c"># Return the form as accpeted to QGIS.</span>
    <span class="n">myDialog</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">Name_onTextChanged</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">nameField</span><span class="o">.</span><span class="n">text</span><span class="p">()</span><span class="o">.</span><span class="n">length</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">nameField</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s">&quot;background-color: rgba(255, 107, 107, 150);&quot;</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">nameField</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Ici la partie importante est <strong>nameField.textChanged.connect(Name_onTextChanged)</strong> et la méthode <strong>Name_onTextChanged(text)</strong>.
Essayez, cela devrait fonctionner.</p>
</div>
<div class="section" id="exercice">
<h2>Exercice<a class="headerlink" href="#exercice" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Faites de même avec d&#8217;autres champs du fichier.</li>
<li>Désactivez la possibilité d&#8217;éditer l&#8217;identifiant de la feature</li>
<li>Prenez un champ date et validez que la date est postérieure à 1900</li>
<li>Vérifiez que les champs SOVISO, SOV_A3 ont bien le bon nombre de lettres</li>
<li>Faites en sorte que l&#8217;utilisateur ne puisse choisir qu&#8217;entre les 5 valeurs possibles du champ &#8216;TYPE&#8217;</li>
<li>Faites de même avec une de vos couches de données</li>
<li>Créez une nouvelle couche de données avec des points référençant des noms de photos sur le disque, et affichez les dans le formulaire</li>
</ul>
</div>
</div>


        </div><!-- span9 -->
      </div><!-- row -->
    </div> <!-- container -->
    <div class="alert alert-info">
          &copy; Copyright 2011, Greg Corradini and Aaron Racicot.
    </div>
  </body>
</html>